<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>File Processing</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f9f9f9;
        }

        .file-upload {
            margin: 20px 0;
        }

        #logTerminal {
            width: 100%;
            height: 200px;
            background-color: #222;
            color: #fff;
            font-family: "Courier New", monospace;
            padding: 10px;
            margin-bottom: 20px;
            overflow-y: scroll;
            white-space: pre-wrap;
        }

        #progressBar {
            width: 100%;
            background-color: #ddd;
        }

        #progressBar div {
            height: 20px;
            background-color: #4caf50;
            text-align: center;
            line-height: 20px;
            color: white;
        }

        button {
            padding: 10px;
            background-color: #4caf50;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:disabled {
            background-color: #ccc;
        }

        #downloadLink, #logDownloadButton {
            display: none;
            margin-top: 20px;
            padding: 10px;
            background-color: #007BFF;
            color: white;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div id="logTerminal">Log Start</div>

    <div class="file-upload">
        <input type="file" id="dumpFile">
        <button id="processDump">Process File</button>
    </div>

    <div id="progressBar"><div>0%</div></div>

    <div id="resultsTableContainer">
        <table border="1" cellpadding="5" cellspacing="0" style="width: 100%;">
            <thead>
                <tr>
                    <th>Function Name</th>
                    <th>Offset</th>
                    <th>Patch</th>
                </tr>
            </thead>
            <tbody id="resultsTableBody">
                <!-- Results will appear here -->
            </tbody>
        </table>
    </div>

    <a id="downloadLink" href="#" download="extracted_data.txt">Download Extracted Data</a>
    <button id="logDownloadButton">Download Log</button>

    <footer>
        <p>Footer Content Here</p>
    </footer>

    <script>
        const processDumpButton = document.getElementById('processDump');
        const resultsTableBody = document.getElementById('resultsTableBody');
        const progressBar = document.querySelector('#progressBar div');
        const downloadLink = document.getElementById('downloadLink');
        const logDownloadButton = document.getElementById('logDownloadButton');
        const logTerminal = document.getElementById('logTerminal');
        let logContent = 'Log Start\n';

        // Function to load the function.txt file from the same directory
        function loadFunctionsFromFile() {
            const functions = [];
            fetch('function.txt')
                .then(response => response.text())
                .then(fileContent => {
                    logTerminal.textContent += '\nFunction file loaded successfully.\n';
                    const lines = fileContent.split('\n');
                    lines.forEach(line => {
                        const parts = line.split('|');
                        if (parts.length === 3) {
                            const fn = parts[0].trim();
                            const fn2 = parts[1].trim();
                            const patch = parts[2].trim();
                            functions.push({ fn, fn2, patch });
                        }
                    });
                    logTerminal.textContent += 'Functions parsed.\n';
                    return functions;
                })
                .catch(error => {
                    logTerminal.textContent += `Error loading function.txt: ${error.message}\n`;
                    alert('Error loading function.txt');
                });
        }

        processDumpButton.addEventListener('click', () => {
            const fileInput = document.getElementById('dumpFile');
            const file = fileInput.files[0];

            if (!file) {
                logContent += 'Error: No dump file selected.\n';
                updateLog();
                alert('Please upload a dump file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                const content = event.target.result;
                loadFunctionsFromFile().then(functions => {
                    if (functions.length === 0) {
                        logTerminal.textContent += 'Error: No functions found in the function.txt file.\n';
                        return;
                    }
                    processDump(content, functions); // Process the dump using the loaded functions
                });
            };
            reader.onerror = () => {
                logTerminal.textContent += 'Error reading dump file.\n';
                alert('Error reading dump file.');
            };
            reader.readAsText(file);
        });

        function processDump(content, functions) {
            resultsTableBody.innerHTML = '';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';

            const lines = content.split('\n');
            let extractedData = '';
            let processedCount = 0;
            const totalFunctions = functions.length;

            functions.forEach((func, index) => {
                setTimeout(() => {
                    let foundOffset = 'Not found';
                    lines.forEach(line => {
                        if (line.includes(func.fn2)) {
                            const offsetMatch = line.match(/0x[\da-fA-F]+/);
                            if (offsetMatch) {
                                foundOffset = offsetMatch[0];
                            }
                        }
                    });

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${func.fn}</td>
                        <td>${foundOffset}</td>
                        <td>${func.patch}</td>
                    `;
                    resultsTableBody.appendChild(row);

                    extractedData += `Mod: ${func.fn}\nOffset: ${foundOffset}\nPatch: ${func.patch}\n\n`;

                    processedCount++;
                    const progress = Math.round((processedCount / totalFunctions) * 100);
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${progress}%`;

                    if (processedCount === totalFunctions) {
                        finalizeProcessing(extractedData);
                    }
                }, 200 * index); // Incrementally process functions with a delay
            });
        }

        function finalizeProcessing(data) {
            const blob = new Blob([data], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            downloadLink.href = url;
            downloadLink.download = 'extracted_data.txt';
            downloadLink.style.display = 'block';
            downloadLink.innerText = 'Download Extracted Data';
        }

        function updateLog() {
            const logBlob = new Blob([logContent], { type: 'text/plain' });
            const logUrl = URL.createObjectURL(logBlob);
            logDownloadButton.href = logUrl;
            logDownloadButton.download = 'process_log.txt';
            logDownloadButton.style.display = 'block';
            logDownloadButton.innerText = 'Download Log';
        }
    </script>
</body>
</html>
